{
  "hash": "8da6278199fc364fb100a5b79d28e536",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Randomization and sample size estimation\"\nauthor: \"Andrew D. Nguyen, PhD\"\ndate: \"2025-04-19\"\ntoc: TRUE\n---\n\n\\newpage\n\n# Introduction:\n\nThe aim of this demo is to showcase how to estimate sample sizes and conduct randomization in clinical trial designs. R has a suite of packages geared towards clinical trial design, monitoring, and analyses (CRAN R Projects- Clinical Trials @zhang_cran_2021). I'm also modeling my demo off of Peter Higgin's *Reproducible Medical Research with R* book, chapter 20 (@higgins_2023).\n\n# Load Libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse) # for ggplot2, data visualization and data filtering with dplyr \nlibrary(ggbeeswarm) # for quasirandom plotting\nlibrary(pwr) # power analysis\nlibrary(gsDesign) # power analysis for survival\nlibrary(blockrand) # randomization package\nlibrary(randomizeR)# another randomization package\n\n#ggplot2 settings I like: \nT<-theme_bw()+theme(,text=element_text(size=18),\n                    axis.text=element_text(size=18),\n                    panel.grid.major=element_blank(),\n                    panel.grid.minor.x = element_blank(),\n                    panel.grid = element_blank(),\n                    legend.key = element_blank(),\n                    axis.title.y=element_text(margin=margin(t=0,r=15,b=0,l=0)),\n                    axis.title.x=element_text(margin=margin(t=15,r=,b=0,l=0)))\n#+ theme(legend.position=\"none\")\n```\n:::\n\n\n# Sample size calculations\n\nIt is important to find the appropriate number of participants in a clinical trial because too few participants may lead to an inability to detect differences (studies may be underpowered) and too many participants lead to excessive use of resources.\n\nThe critical information to obtain are:\n\n-   alpha ($\\alpha$) level - probability of committing a type I error (false positive)\\\n-   beta ($\\beta$) level - probability of committing a type II error (false negative)\n    -   sometimes the program will ask for power, which is 1-$\\beta$ and is the probability of detecting differences if they truly exist\\\n-   effect size between groups (*cohen's d*)\n    -   Note that cohen's d is expressed as: $\\frac{(\\bar\\mu_1 - \\bar\\mu_2)}{S_{pooled}}$, where $\\bar\\mu_1$ is the mean of one group and $\\bar\\mu_2$ is the mean of the other group, and $S_{pooled}$ is the pooled standard deviation. Therefore, cohen's d is interpreted in units of standard deviation.\\\n-   drop out rates\n\nOther information to consider for survival analyses:\n\n-   rate of enrollment\\\n-   length of study\\\n-   hazard rate of each group\n\n## T-test designs and sample size calculations\n\nWe will be using the *pwr* package. To start, let's estimate a sample size with:\n\n-   alpha = 0.05\\\n-   power = 0.80 (1-$\\beta$)\\\n-   effect size, cohen's d = 0.5, which is considered a moderate effect size\n\n\n::: {.cell}\n\n```{.r .cell-code}\npwr::pwr.t.test(sig.level=0.05,type=\"two.sample\",power=.8,d=.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     Two-sample t test power calculation \n\n              n = 63.76561\n              d = 0.5\n      sig.level = 0.05\n          power = 0.8\n    alternative = two.sided\n\nNOTE: n is number in *each* group\n```\n\n\n:::\n:::\n\n\n**Key result: 64 volunteers per arm.** We round up because there can be no fractional individuals.\n\nFor a different study design, let's assume there is a before and after measurement of a continuous variable and this would produce paired results with the same assumptions about $\\alpha$,$\\beta$, and cohen's d.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npwr::pwr.t.test(sig.level=0.05,type=\"paired\",power=.8,d=.5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     Paired t test power calculation \n\n              n = 33.36713\n              d = 0.5\n      sig.level = 0.05\n          power = 0.8\n    alternative = two.sided\n\nNOTE: n is number of *pairs*\n```\n\n\n:::\n:::\n\n\n**Key result: 34 volunteers per arm.**\n\nWe also may need to consider drop out rates. For example, if there is a 20% drop out rate, then add 20% to the sample sizes per arm. 34 x 20% = \\~7, so we would need 41 volunteers.\n\n### Simulating effect sizes and power\n\nWhat if we don't know the effect size and want to find out sample sizes based on different inputs of effect size and power?\n\n-   simulating effect sizes from 0 to 2 in .1 increments\\\n-   over two levels of power (0.8 and .9)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#code to get sample size from pwr.t.test\n#round(pwr::pwr.t.test(sig.level=0.05,type=\"two.sample\",power=.8,d=c(.5),n=NULL)$n,0)\n\nd<-data.frame(efsize=rep(seq(0.1,2,.1),2),\n              power=c(rep(.8,length(seq(0.1,2,.1))),\n                      rep(.9,length(seq(0.1,2,.1)))))\nd%>%\n  group_by(efsize,power)%>%\n  mutate(n=round(pwr::pwr.t.test(sig.level=0.05,\n                                 type=\"two.sample\",power=power,\n                                 d=efsize,n=NULL)$n,0),\n         power2=paste(\"Power = \",power,sep=\"\"))%>%\n  #power2 is for plotting\n  ggplot(.,aes(x=efsize,y=n,colour=factor(power)))+\n  geom_point()+geom_line()+\n  theme_minimal()+\n  geom_text(aes(label=n),vjust=-1)+\n  facet_wrap(~power2,ncol=1)+\n  xlab(\"Effect size (cohen's d)\")+\n  ylab(\"Sample size per arm\")+\n  theme(legend.position = \"none\")+\n  scale_x_continuous(,limits=c(0,2)\n                     ,breaks=seq(0,2,.25),\n                     labels=seq(0,2,.25))+\n  scale_y_continuous(limits=c(0,2500))\n```\n\n::: {.cell-output-display}\n![](Randomization_and_Power_analysis_files/figure-pdf/simulate t.test effsize power-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## Chi-square 2x2 contingency table design\n\nIn this design, let's say there are counts of diseased and not-diseased individuals that were exposed and not exposed to some chemical. We want to find the association between the two variables and we need to specify the expected proportions of the 2x2 under the alternative hypothesis.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#ES.w2() # chi-square for test of association\n#pwr.chisq.test()\n\nd2<-data.frame(exposure=c(\"exposed\",\"not exposed\"),non_diseased=c(.25,.3),diseased=c(0.25,.2))\nknitr::kable(d2)\n```\n\n::: {.cell-output-display}\n\n\n|exposure    | non_diseased| diseased|\n|:-----------|------------:|--------:|\n|exposed     |         0.25|     0.25|\n|not exposed |         0.30|     0.20|\n\n\n:::\n:::\n\n\nNow that we have the expected 2x2 matrix under the alternative hypothesis (not independent), then we need to identify the effect size with *ES.w2()* and then plug and chug with *pwr.chisq.test()* with $\\alpha$ = 0.05 and power = 0.8.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nef.sim.dat<-ES.w2(d2[,-1])\npwr.chisq.test(w=ef.sim.dat,df=1,power=.8,sig.level=.05)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     Chi squared power calculation \n\n              w = 0.1005038\n              N = 777.0372\n             df = 1\n      sig.level = 0.05\n          power = 0.8\n\nNOTE: N is the number of observations\n```\n\n\n:::\n:::\n\n\n**Key result: We need 778 observations.** Note that the degrees of freedom on 1 in this case for a 2x2 contingency table, which is calculated as (\\# of columns - 1) x (\\# of rows -1).\n\n## Time to event types of designs (survival analyses)\n\nI will be using the *gsDesign* package and referencing an online resource [**here**](https://cran.r-project.org/web/packages/gsDesign/vignettes/SurvivalOverview.html).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhr=.7 # hazard ratio\ncontrolMedian<-8 # 8 months\nlambda1 <- log(2) / controlMedian #estimated hazard rate of control\n\nnSurvival(\n  lambda1 = lambda1,\n  lambda2 = lambda1 * hr, #hazard rate for experimental\n  Ts = 24, #24 months\n  Tr = 6, # 6 months\n  eta = .1, # value per month dropout rate\n  ratio = 1, # equal sampling\n  alpha = .05,\n  beta = .2\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nFixed design, two-arm trial with time-to-event\noutcome (Lachin and Foulkes, 1986).\nStudy duration (fixed):          Ts=24\nAccrual duration (fixed):        Tr=6\nUniform accrual:              entry=\"unif\"\nControl median:      log(2)/lambda1=8\nExperimental median: log(2)/lambda2=11.4\nCensoring median:        log(2)/eta=6.9\nControl failure rate:       lambda1=0.087\nExperimental failure rate:  lambda2=0.061\nCensoring rate:                 eta=0.1\nPower:                 100*(1-beta)=80%\nType I error (1-sided):   100*alpha=5%\nEqual randomization:          ratio=1\nSample size based on hazard ratio=0.7 (type=\"rr\")\nSample size (computed):           n=476\nEvents required (computed): nEvents=195\n```\n\n\n:::\n:::\n\n\n# Randomization (stratified permuted block randomization)\n\nUsing the t-test design (2 trial arms), we'd like to implement block randomization across a strata. Often times, we can't sample participants all at once and so we need to apply treatments in groupings as they enroll in the study, or blocks. To ensure equal sampling of treatments across different sub-populations, randomization can be conducted at the level of different sub-populations (strata). For example, randomization can be conducted for males and females separately. With a sample size of 200 per arm, in a two-arm trial, I'm randomization across a gender strata (100 each so they're equally sampled).\n\n## ...with *blockrand* package\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmrand<-blockrand(n = 100, \n                     num.levels = 2, # three treatments\n                     levels = c(\"Con.Arm\", \"Treat.Arm\"), # arm names\n                     stratum = \"Strat.male\", # stratum name\n                     id.prefix = \"SM\", # stratum abbrev\n                     block.sizes = c(3,4), # times arms = 6,8\n                     block.prefix = \"blksm\") # stratum abbrev\n\nfrand<-blockrand(n = 100, \n                     num.levels = 2, # three treatments\n                     levels = c(\"Con.Arm\", \"Treat.Arm\"), # arm names\n                     stratum = \"Strat.female\", # stratum name\n                     id.prefix = \"SF\", # stratum abbrev\n                     block.sizes = c(3,4), # times arms = 6,8\n                     block.prefix = \"blkfm\") # stratum abbrev\ntotrand<-rbind(mrand,frand)\nknitr::kable(head(totrand,25))\n```\n\n::: {.cell-output-display}\n\n\n|id    |stratum    |block.id | block.size|treatment |\n|:-----|:----------|:--------|----------:|:---------|\n|SM001 |Strat.male |blksm01  |          6|Con.Arm   |\n|SM002 |Strat.male |blksm01  |          6|Treat.Arm |\n|SM003 |Strat.male |blksm01  |          6|Treat.Arm |\n|SM004 |Strat.male |blksm01  |          6|Con.Arm   |\n|SM005 |Strat.male |blksm01  |          6|Treat.Arm |\n|SM006 |Strat.male |blksm01  |          6|Con.Arm   |\n|SM007 |Strat.male |blksm02  |          8|Con.Arm   |\n|SM008 |Strat.male |blksm02  |          8|Con.Arm   |\n|SM009 |Strat.male |blksm02  |          8|Treat.Arm |\n|SM010 |Strat.male |blksm02  |          8|Con.Arm   |\n|SM011 |Strat.male |blksm02  |          8|Treat.Arm |\n|SM012 |Strat.male |blksm02  |          8|Treat.Arm |\n|SM013 |Strat.male |blksm02  |          8|Treat.Arm |\n|SM014 |Strat.male |blksm02  |          8|Con.Arm   |\n|SM015 |Strat.male |blksm03  |          6|Treat.Arm |\n|SM016 |Strat.male |blksm03  |          6|Treat.Arm |\n|SM017 |Strat.male |blksm03  |          6|Con.Arm   |\n|SM018 |Strat.male |blksm03  |          6|Con.Arm   |\n|SM019 |Strat.male |blksm03  |          6|Treat.Arm |\n|SM020 |Strat.male |blksm03  |          6|Con.Arm   |\n|SM021 |Strat.male |blksm04  |          6|Con.Arm   |\n|SM022 |Strat.male |blksm04  |          6|Treat.Arm |\n|SM023 |Strat.male |blksm04  |          6|Con.Arm   |\n|SM024 |Strat.male |blksm04  |          6|Con.Arm   |\n|SM025 |Strat.male |blksm04  |          6|Treat.Arm |\n\n\n:::\n:::\n\n\nWe can then create patient randomization \"cards\" based on the *blockrand()* output.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplotblockrand(totrand,'mystudy.pdf',\n              top=list(text=c('MyStudy','Patient:%ID%','Treatment:%TREAT%'),\n                       col=c('black','black','red'),font=c(1,1,4)),\n              middle=list(text=c(\"MyStudy\",\"Sex:%STRAT%\",\"Patient:%ID%\"),\n                          col=c('black','blue','green'),font=c(1,2,3)),\n              bottom=\"Call123-4567toreportpatiententry\", cut.marks=TRUE)\n```\n:::\n\n\n## ...with *randomizeR* package\n\nUsing the randomized permuted block randomization function, *rpbrPar()*. The details:\n\n> Fix the possible random block lengths rb, the number of treatment groups K, the sample size N and the vector of the ratio. Afterwards, one block length is randomly selected of the random block lengths. The patients are assigned according to the ratio to the corresponding treatment groups. This procedure is repeated until N patients are assigned. Within each block all possible randomization sequences are equiprobable.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#randomization parameters\nmales<-rpbrPar(N=100, #total sample size\n               rb=6, # block length parameter\n               K=2) # number of groups\nrr<-genSeq(males) # saving randomization procedure\nrr.out<-as.vector(getRandList(rr))# grab randomizations\n#put into dataframe and make it look better\nmale.r.dat<-data.frame(sex=\"M\",\n                       subject=paste(\"SM\",\n                                     seq(1:length(rr.out)),sep=\"\"),\n                       treatment=rr.out,\n                       treatmentname=ifelse(rr.out==\"A\",\"Control\",\"Treatment\"))\n#male.r.dat\nknitr::kable(head(male.r.dat,10))\n```\n\n::: {.cell-output-display}\n\n\n|sex |subject |treatment |treatmentname |\n|:---|:-------|:---------|:-------------|\n|M   |SM1     |A         |Control       |\n|M   |SM2     |B         |Treatment     |\n|M   |SM3     |A         |Control       |\n|M   |SM4     |A         |Control       |\n|M   |SM5     |B         |Treatment     |\n|M   |SM6     |B         |Treatment     |\n|M   |SM7     |B         |Treatment     |\n|M   |SM8     |A         |Control       |\n|M   |SM9     |A         |Control       |\n|M   |SM10    |A         |Control       |\n\n\n:::\n:::\n\n\n# Session Info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.0 (2025-04-11 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26100)\n\nMatrix products: default\n  LAPACK version 3.12.1\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/New_York\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n [1] randomizeR_3.0.2 mvtnorm_1.3-3    survival_3.8-3   plotrix_3.8-4   \n [5] blockrand_1.5    gsDesign_3.6.7   pwr_1.3-0        ggbeeswarm_0.7.2\n [9] lubridate_1.9.4  forcats_1.0.0    stringr_1.5.1    dplyr_1.1.4     \n[13] purrr_1.0.4      readr_2.1.5      tidyr_1.3.1      tibble_3.2.1    \n[17] ggplot2_3.5.2    tidyverse_2.0.0 \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6      beeswarm_0.4.0    xfun_0.52         coin_1.4-3       \n [5] insight_1.1.0     lattice_0.22-6    tzdb_0.5.0        vctrs_0.6.5      \n [9] tools_4.5.0       generics_0.1.3    sandwich_3.1-1    stats4_4.5.0     \n[13] parallel_4.5.0    pkgconfig_2.0.3   Matrix_1.7-3      gt_1.0.0         \n[17] lifecycle_1.0.4   farver_2.1.2      compiler_4.5.0    munsell_0.5.1    \n[21] tinytex_0.57      codetools_0.2-20  PwrGSD_2.3.8      vipor_0.4.7      \n[25] htmltools_0.5.8.1 yaml_2.3.10       pillar_1.10.2     MASS_7.3-65      \n[29] multcomp_1.4-28   r2rtf_1.1.4       tidyselect_1.2.1  digest_0.6.37    \n[33] stringi_1.8.7     reshape2_1.4.4    labeling_0.4.3    splines_4.5.0    \n[37] fastmap_1.2.0     grid_4.5.0        colorspace_2.1-1  cli_3.6.4        \n[41] magrittr_2.0.3    TH.data_1.1-3     libcoin_1.0-10    withr_3.0.2      \n[45] scales_1.3.0      timechange_0.3.0  rmarkdown_2.29    matrixStats_1.5.0\n[49] zoo_1.8-14        modeltools_0.2-23 hms_1.1.3         evaluate_1.0.3   \n[53] knitr_1.50        rlang_1.1.6       Rcpp_1.0.14       xtable_1.8-4     \n[57] glue_1.8.0        xml2_1.3.8        jsonlite_2.0.0    R6_2.6.1         \n[61] plyr_1.8.9       \n```\n\n\n:::\n:::\n\n\n\n",
    "supporting": [
      "Randomization_and_Power_analysis_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}