{
  "hash": "5d4e9e707e3fb64b3f707f45f9f1226b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Time series causal impact with CausalImpact\"\ntoc: true\ndate: \"2024-04-02\"\neditor_options:\n  chunk_output_type: console\n---\n\n# Load libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(CausalImpact) # R package for determining \nlibrary(dplyr) # R package for data wrangling\nlibrary(ggplot2) # R package for plotting\nlibrary(gt) # R package for constructing tables\n\n#.libPaths()\n```\n:::\n\n\n# Simulate synthetic control data and focal time series data\n\nFollowing this tutorial: <https://google.github.io/CausalImpact/CausalImpact.html>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1)\nx1 <- 100 + arima.sim(model = list(ar = 0.999), n = 100) # createa  control variable\ny <- 1.2 * x1 + rnorm(100) # create the quality metric variable that is dependent on x1 (control variable)\ny[71:100] <- y[71:100] + 10 \ndata <- cbind(y, x1) # combine the datasets \nplot(data) # plot the datasets, roughly\n```\n\n::: {.cell-output-display}\n![](10_TimeSeriesCausalImpact_files/figure-html/increase-1.png){width=672}\n:::\n:::\n\n\n# What the simulated data look like:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#let's see what the data look like \nhead(round(tibble(y1=data[,1],x1=data[,2]),1),6)|>\n  gt()\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"segtiwbtpw\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#segtiwbtpw table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#segtiwbtpw thead, #segtiwbtpw tbody, #segtiwbtpw tfoot, #segtiwbtpw tr, #segtiwbtpw td, #segtiwbtpw th {\n  border-style: none;\n}\n\n#segtiwbtpw p {\n  margin: 0;\n  padding: 0;\n}\n\n#segtiwbtpw .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #A8A8A8;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #A8A8A8;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#segtiwbtpw .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#segtiwbtpw .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#segtiwbtpw .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_col_heading {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#segtiwbtpw .gt_column_spanner_outer {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#segtiwbtpw .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#segtiwbtpw .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#segtiwbtpw .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#segtiwbtpw .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#segtiwbtpw .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#segtiwbtpw .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  vertical-align: middle;\n}\n\n#segtiwbtpw .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#segtiwbtpw .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#segtiwbtpw .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#segtiwbtpw .gt_stub {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#segtiwbtpw .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#segtiwbtpw .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#segtiwbtpw .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#segtiwbtpw .gt_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#segtiwbtpw .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#segtiwbtpw .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_grand_summary_row {\n  color: #333333;\n  background-color: #FFFFFF;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#segtiwbtpw .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_striped {\n  background-color: rgba(128, 128, 128, 0.05);\n}\n\n#segtiwbtpw .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D3D3D3;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#segtiwbtpw .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#segtiwbtpw .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#segtiwbtpw .gt_left {\n  text-align: left;\n}\n\n#segtiwbtpw .gt_center {\n  text-align: center;\n}\n\n#segtiwbtpw .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#segtiwbtpw .gt_font_normal {\n  font-weight: normal;\n}\n\n#segtiwbtpw .gt_font_bold {\n  font-weight: bold;\n}\n\n#segtiwbtpw .gt_font_italic {\n  font-style: italic;\n}\n\n#segtiwbtpw .gt_super {\n  font-size: 65%;\n}\n\n#segtiwbtpw .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#segtiwbtpw .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#segtiwbtpw .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#segtiwbtpw .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#segtiwbtpw .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#segtiwbtpw .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#segtiwbtpw .gt_indent_5 {\n  text-indent: 25px;\n}\n\n#segtiwbtpw .katex-display {\n  display: inline-flex !important;\n  margin-bottom: 0.75em !important;\n}\n\n#segtiwbtpw div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {\n  height: 0px !important;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"y1\">y1</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"x1\">x1</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">105.3</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">88.2</td></tr>\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">105.9</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">88.5</td></tr>\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">106.6</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">87.9</td></tr>\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">106.2</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">86.8</td></tr>\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">101.3</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">84.6</td></tr>\n    <tr><td headers=\"y1\" class=\"gt_row gt_right\">101.4</td>\n<td headers=\"x1\" class=\"gt_row gt_right\">84.6</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n# Run analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\npre<-c(1,70) # set the pre period with no intervention\npost<-c(71,100) # set the post period, after the intervention\n\nimpact<-CausalImpact(data,pre,post) # Conduct the analysis\n\nplot(impact) # plot the results\n```\n\n::: {.cell-output-display}\n![](10_TimeSeriesCausalImpact_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#summary(impact,\"report\")\n```\n:::\n\n\n# Analysis report from the R package\n\nAnalysis report {CausalImpact}\n\nDuring the post-intervention period, the response variable had an average value of approx. 117.05. By contrast, in the absence of an intervention, we would have expected an average response of 106.54. The 95% interval of this counterfactual prediction is [105.84, 107.29]. Subtracting this prediction from the observed response yields an estimate of the causal effect the intervention had on the response variable. This effect is 10.51 with a 95% interval of [9.76, 11.21]. For a discussion of the significance of this effect, see below.\n\nSumming up the individual data points during the post-intervention period (which can only sometimes be meaningfully interpreted), the response variable had an overall value of 3.51K. By contrast, had the intervention not taken place, we would have expected a sum of 3.20K. The 95% interval of this prediction is [3.18K, 3.22K].\n\nThe above results are given in terms of absolute numbers. In relative terms, the response variable showed an increase of +10%. The 95% interval of this percentage is [+9%, +11%].\n\nThis means that the positive effect observed during the intervention period is statistically significant and unlikely to be due to random fluctuations. It should be noted, however, that the question of whether this increase also bears substantive significance can only be answered by comparing the absolute effect (10.51) to the original goal of the underlying intervention.\n\nThe probability of obtaining this effect by chance is very small (Bayesian one-sided tail-area probability p = 0.001). This means the causal effect can be considered statistically significant.\n\n## Output table\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::kable(t(round(impact$summary,2)))\n```\n\n::: {.cell-output-display}\n\n\n|                | Average| Cumulative|\n|:---------------|-------:|----------:|\n|Actual          |  117.05|    3511.46|\n|Pred            |  106.54|    3196.12|\n|Pred.lower      |  105.86|    3175.73|\n|Pred.upper      |  107.27|    3218.05|\n|Pred.sd         |    0.37|      11.13|\n|AbsEffect       |   10.51|     315.34|\n|AbsEffect.lower |    9.78|     293.41|\n|AbsEffect.upper |   11.19|     335.72|\n|AbsEffect.sd    |    0.37|      11.13|\n|RelEffect       |    0.10|       0.10|\n|RelEffect.lower |    0.09|       0.09|\n|RelEffect.upper |    0.11|       0.11|\n|RelEffect.sd    |    0.00|       0.00|\n|alpha           |    0.05|       0.05|\n|p               |    0.00|       0.00|\n\n\n:::\n:::\n\n\n# stylized figure\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#splitting out datasets\n#names(impact$series)\n\n\norig<-impact$series|>\n  data.frame()|>\n  tibble()|>\n  dplyr::select(response,point.pred,point.pred.lower,point.pred.upper)\n\ncf<-ggplot(orig,aes(x=seq(1,100,1),y=point.pred))+geom_vline(xintercept=70,colour='#AA1E2D',lwd=1)+geom_line(linetype=\"dotdash\",linewidth=1.2,colour='#404C58')+geom_ribbon(aes(ymax=point.pred.upper,ymin=point.pred.lower),fill=\t'#DC5C1D',alpha=.2)+geom_line(aes(y=response),linewidth=1.2,colour='#2A3C47')+theme_bw()+ylab(\"Y variable\")+xlab(\"Time\")+geom_line(aes(y=x1),colour='#65C9D5',linewidth=2)+scale_y_continuous(limits=c(80,130))+annotate(\"text\",x=c(90,80,87),y=c(85,125,100),label=c(\"Control Variable\",\"Observed data\",\"Counterfactual Synthetic Control\"))\ncf\n```\n\n::: {.cell-output-display}\n![](10_TimeSeriesCausalImpact_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n\n```{.r .cell-code}\n#ggsave(cf,filename=\"Timeseriesbayesian.png\",width=8,height=5,dpi=600,unit=\"in\")\n#geom_text(aes(x=c(10,75),y=c(90,125),label=c(\"Synthetic Control\",\"Observed data\")))+\n\n\n#cf1<-ggplot(orig,aes(x=seq(1,100,1),y=point.pred))+geom_vline(xintercept=70,colour='#AA1E2D',lwd=1)+geom_line(aes(y=response),linewidth=1.2,colour='#2A3C47')+theme_bw()+ylab(\"Y variable\")+xlab(\"Time\")\n#cf1\n#ggsave(cf1,filename=\"observed_data_timeseries.png\",width=10,height=5,unit=\"in\",dpi=600)\n\n\n#cf2<-ggplot(orig,aes(x=seq(1,100,1),y=point.pred))+geom_vline(xintercept=70,colour='#AA1E2D',lwd=1)+geom_line(aes(y=response),linewidth=1.2,colour='#2A3C47')+theme_bw()+ylab(\"Y variable\")+xlab(\"Time\")+geom_line(linetype=\"dotdash\",linewidth=1.2,colour='#404C58')+geom_ribbon(aes(ymax=point.pred.upper,ymin=point.pred.lower),fill=\t'#DC5C1D',alpha=.2)\n#cf2\n#ggsave(cf2,filename=\"observed_data_timeseries_with_counterfactual.png\",width=10,height=5,unit=\"in\",dpi=600)\n```\n:::\n\n\n# Session Info\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsessionInfo()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nR version 4.5.0 (2025-04-11 ucrt)\nPlatform: x86_64-w64-mingw32/x64\nRunning under: Windows 11 x64 (build 26100)\n\nMatrix products: default\n  LAPACK version 3.12.1\n\nlocale:\n[1] LC_COLLATE=English_United States.utf8 \n[2] LC_CTYPE=English_United States.utf8   \n[3] LC_MONETARY=English_United States.utf8\n[4] LC_NUMERIC=C                          \n[5] LC_TIME=English_United States.utf8    \n\ntime zone: America/New_York\ntzcode source: internal\n\nattached base packages:\n[1] stats     graphics  grDevices utils     datasets  methods   base     \n\nother attached packages:\n[1] gt_1.0.0            ggplot2_3.5.2       dplyr_1.1.4        \n[4] CausalImpact_1.3.0  bsts_0.9.10         xts_0.14.1         \n[7] zoo_1.8-14          BoomSpikeSlab_1.2.6 Boom_0.9.15        \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6      jsonlite_2.0.0    compiler_4.5.0    tidyselect_1.2.1 \n [5] xml2_1.3.8        assertthat_0.2.1  scales_1.3.0      yaml_2.3.10      \n [9] fastmap_1.2.0     lattice_0.22-6    R6_2.6.1          labeling_0.4.3   \n[13] generics_0.1.3    knitr_1.50        htmlwidgets_1.6.4 MASS_7.3-65      \n[17] tibble_3.2.1      munsell_0.5.1     pillar_1.10.2     rlang_1.1.6      \n[21] xfun_0.52         sass_0.4.10       cli_3.6.4         withr_3.0.2      \n[25] magrittr_2.0.3    digest_0.6.37     grid_4.5.0        lifecycle_1.0.4  \n[29] vctrs_0.6.5       evaluate_1.0.3    glue_1.8.0        farver_2.1.2     \n[33] colorspace_2.1-1  rmarkdown_2.29    tools_4.5.0       pkgconfig_2.0.3  \n[37] htmltools_0.5.8.1\n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "10_TimeSeriesCausalImpact_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}